@using Automotive_Project.Extensions
@using System.Security.Claims
@inject CustomSignInManager<UserAccount> _customSignInManager;
@inject CustomUserManager<UserAccount> customUserManager;

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Automotive_Project</title>
    <script type="importmap"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/Automotive_Project.styles.css" asp-append-version="true" />
</head>
<body>


    <script>
        function getShoppingCart() {


            const cookieName = "shopping_cart";
            let cookiesArray = document.cookie.split(';');

            for (let i = 0; i < cookiesArray.length; i++) {
                let cookie = cookiesArray[i];
                if (cookie.includes(cookieName)) {
                    let cookie_value = cookie.substring(cookie.indexOf("=") + 1);

                    try {
                        let cart = JSON.parse(atob(cookie_value));
                        return cart;
                    }
                    catch (exception) {
                        break;
                    }
                }
            }

            return {};
        }


        function saveCart(cart) {
            let cartStr = btoa(JSON.stringify(cart))

            // save cookie
            let d = new Date();
            d.setDate(d.getDate() + 365); // this cookie expires after 365 days (1 year)
            let expires = d.toUTCString();
            document.cookie = "shopping_cart=" + cartStr + ";expires=" + expires + ";path=/; SameSite=Strict; Secure";
        }



        function addToCart(button, id) {
            let cart = getShoppingCart();

            let quantity = cart[id]
            if (isNaN(quantity)) {
                // quantity is Not a Number => set quantity to 1
                cart[id] = 1
            }
            else {
                cart[id] = Number(quantity) + 1;
            }

            saveCart(cart);
            button.innerHTML = "Added <i class='bi bi-check-lg'></i>";

            let cartSize = 0;
            for (var cartItem of Object.entries(cart)) {
                quantity = cartItem[1]
                if (isNaN(quantity)) continue;

                cartSize += Number(quantity)
            }

            document.getElementById("CartSize").innerHTML = cartSize
        }


        function increase(id) {
            let cart = getShoppingCart();

            let quantity = cart[id]
            if (isNaN(quantity)) {
                // quantity is Not a Number => set it to 1
                cart[id] = 1
            }
            else {
                cart[id] = Number(quantity) + 1;
            }

            saveCart(cart);
            location.reload()
        }

        function decrease(id) {
            let cart = getShoppingCart();

            let quantity = cart[id]
            if (isNaN(quantity)) {
                // quantity is Not a Number => exit
                return
            }

            quantity = Number(quantity)

            if (quantity > 1) {
                cart[id] = quantity - 1
                saveCart(cart)
                location.reload()
            }
        }

        function remove(id) {
            let cart = getShoppingCart();

            if (cart[id]) {
                delete cart[id]
                saveCart(cart)
                location.reload()
            }
        }
    </script>

    <header>
        <nav class="navbar navbar-expand-lg bg-body-tertiary shadow p-3 mb-5 rounded">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a asp-controller="Home" asp-action="Index" class="nav-link active" aria-current="page">
                                <i class="bi bi-house"></i>
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-house" viewBox="0 0 16 16">
                                    <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z" />
                                </svg>
                            </a>
                        </li>
                        <li class="nav-item" style="margin-right:60px;">
                            <a class="dropdown-item" asp-area="" asp-controller="Store" asp-action="Index">Store</a>
                        </li>
                    </ul>

                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-12 col-md-8 col-lg-6">
                                <div class="search-container position-relative">
                                    <form class="d-flex align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                             class="search-icon feather feather-search">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                        <input class="form-control search-input ps-5" type="search"
                                               placeholder="Search anything..." aria-label="Search">
                                        <button class="btn btn-search ms-2" type="submit" style="border-radius:40px; width:90px; height:50px;">Search</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (User.Identity?.IsAuthenticated ?? false)
                    {
                        var firstName = User.FindFirst("FirstName")?.Value;
                        var lastName = User.FindFirst("LastName")?.Value;
                        var userName = User.FindFirst("UserName")?.Value;

                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">

                                @if (User.IsInRole("User"))
                                {
                                    
                                    <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        @(firstName + " - (User)")
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" asp-area="" asp-controller="ClientOrders" asp-action="Index">Orders</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" asp-area="" asp-controller="Account" asp-action="Logout">Logout</a></li>
                                    </ul> 
                                    
                                }

                                @if (User.IsInRole("Admin"))
                                {
                                    <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        @(firstName + " - (Admin)")
                                    </a>
                                    <ul class="dropdown-menu">
                                        
                                        <li><a class="dropdown-item" asp-area="" asp-controller="Products" asp-action="Index">Products</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" asp-area="" asp-controller="Account" asp-action="Logout">Logout</a></li>
                                    </ul> 
                                } 

                            </li>
                        </ul>

                    }
                    else
                    {

                        <ul class="navbar-nav me-auto mb-2 mb-lg-0" style="padding: 20px;">
                            <li class="nav-item">
                                <a class="btn btn-primary" asp-area="" asp-controller="Account" asp-action="Login" role="button">Login</a>
                            </li>
                            <li>
                                <a class="btn btn-outline-primary me-2" asp-area="" asp-controller="Account" asp-action="Registration" role="button">SingIn</a>
                            </li>
                        </ul>

                    }

                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item" style="padding-right: 30px; padding-bottom: 25px;">
                            <a class="nav-link text-dark" asp-area="" asp-controller="Cart" asp-action="Index">

                                <span id="CartSize" class="badge rounded-pill bg-danger" style="vertical-align: top">
                                    @CartHelper.GetCartSize(Context.Request, Context.Response)
                                </span>
                                <i class="bi bi-cart"></i>
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-cart" viewBox="0 0 16 16">
                                    <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2" />
                                </svg>

                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
